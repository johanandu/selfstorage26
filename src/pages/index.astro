---
import LayoutV2 from '../layouts/LayoutV2.astro';
import StatsTile from '../components/bento/StatsTile.astro';
import GateTile from '../components/bento/GateTile.jsx';
import WeatherTile from '../components/bento/WeatherTile.astro';
import BookingWizard from '../components/wizard/BookingWizard.jsx';
import { getCollection } from 'astro:content';
import { supabase } from '../lib/supabase';

// Pobierz jednostki z Content Layer (statycznie)
const units = await getCollection('units');

// Pobierz dynamiczne dane dostÄ™pnoÅ›ci (Server Islands)
const { data: availableUnits, error: availabilityError } = await supabase
  .from('units')
  .select('id, status')
  .eq('status', 'available');

const availableCount = availableUnits?.length || 0;
const totalCount = units.length;
const occupancyRate = Math.round(((totalCount - availableCount) / totalCount) * 100);

// Mock data dla statystyk
const stats = {
  totalRevenue: '2.4M PLN',
  activeRentals: 156,
  satisfaction: '4.9/5',
  uptime: '99.9%',
};

// SprawdÅº czy uÅ¼ytkownik jest zalogowany
const isAuthenticated = Astro.cookies.has('sb-access-token');

// Mock active subscription dla GateTile
let hasActiveSubscription = false;
if (isAuthenticated) {
  const token = Astro.cookies.get('sb-access-token');
  if (token) {
    const { data: subscriptions } = await supabase
      .from('subscriptions')
      .select('unit_id')
      .eq('user_id', token.value) // To trzeba przepisaÄ‡ - token to nie user_id
      .eq('status', 'active')
      .gte('valid_until', new Date().toISOString());
    
    hasActiveSubscription = subscriptions && subscriptions.length > 0;
  }
}

// Pobierz pierwszÄ… jednostkÄ™ uÅ¼ytkownika (mock)
const userUnit = hasActiveSubscription ? units[0] : null;
---

<LayoutV2 title="Self-Storage V2.0 - Award Winning Design">
  <!-- Hero Section -->
  <section class="min-h-screen flex items-center justify-center relative overflow-hidden bg-gradient-to-br from-background via-bg-primary to-bg-secondary">
    <!-- Background Elements -->
    <div class="absolute inset-0 opacity-20">
      <div class="absolute top-20 left-20 w-96 h-96 bg-accent rounded-full blur-3xl animate-pulse"></div>
      <div class="absolute bottom-20 right-20 w-96 h-96 bg-blue-500 rounded-full blur-3xl animate-pulse delay-1000"></div>
    </div>

    <div class="container mx-auto px-6 text-center relative z-10">
      <div
        transition:animate="fade"
        class="space-y-8"
      >
        <h1 class="text-6xl md:text-8xl font-bold font-display text-accent mb-6">
          Award Winning<br/>Self-Storage
        </h1>
        <p class="text-xl md:text-2xl text-gray-300 mb-12 max-w-3xl mx-auto leading-relaxed">
          PrzebudowaliÅ›my magazyny od podstaw. Teraz wyglÄ…dajÄ… jak produkt Apple.
        </p>
        
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a
            href="/dashboard"
            class="bg-accent text-text-dark font-bold py-4 px-8 rounded-full text-lg hover:bg-gray-300 transition-all duration-300 hover:scale-105"
          >
            PrzejdÅº do panelu
          </a>
          <button
            id="openWizard"
            class="border border-glass-border bg-glass-bg/50 backdrop-blur-sm text-accent font-bold py-4 px-8 rounded-full text-lg hover:bg-glass-bg transition-all duration-300 hover:scale-105"
          >
            Skonfiguruj magazyn
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Bento Grid Dashboard -->
  <section class="py-20 bg-background">
    <div class="container mx-auto px-6">
      <div class="text-center mb-16">
        <h2 class="text-5xl font-bold font-display text-accent mb-6">Panel kontrolny</h2>
        <p class="text-xl text-gray-300 max-w-2xl mx-auto">
          Wszystko co musisz wiedzieÄ‡ na pierwszy rzut oka
        </p>
      </div>

      <!-- Bento Grid -->
      <div class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-6 gap-6 auto-rows-fr">
        <!-- Large Gate Tile -->
        {userUnit && (
          <GateTile 
            client:load 
            isSubscribed={hasActiveSubscription}
            unitId={userUnit.id}
            unitName={userUnit.data.name}
          />
        )}

        <!-- Stats Tiles -->
        <StatsTile 
          title="DostÄ™pne magazyny" 
          value={availableCount} 
          trend={`+${availableCount}`}
          icon="ðŸ“¦"
          size="medium"
        />
        
        <StatsTile 
          title="ZajÄ™toÅ›Ä‡" 
          value={`${occupancyRate}%`} 
          trend={occupancyRate > 80 ? '+High' : '-Low'}
          icon="ðŸ“Š"
          size="medium"
        />
        
        <StatsTile 
          title="Temperatura" 
          value="12Â°C" 
          icon="ðŸŒ¡ï¸"
          size="small"
        />
        
        <WeatherTile client:load />
        
        <StatsTile 
          title="Aktywne wynajmy" 
          value={stats.activeRentals} 
          trend="+12"
          icon="ðŸ”‘"
          size="medium"
        />
        
        <StatsTile 
          title="Zadowolenie" 
          value={stats.satisfaction} 
          icon="â­"
          size="small"
        />
        
        <StatsTile 
          title="DostÄ™pnoÅ›Ä‡" 
          value={stats.uptime} 
          icon="âœ…"
          size="small"
        />

        {/* B2B & Operations Tiles */}
        {isAuthenticated && (
          <>
            <TeamAccessTile 
              client:load 
              unitId={userUnit?.id}
              unitName={userUnit?.data.name}
            />
            
            <MoveOutTile 
              client:load 
              unitId={userUnit?.id}
              unitName={userUnit?.data.name}
              subscriptionId="mock-subscription-id"
            />
          </>
        )}
      </div>
    </div>
  </section>

  <!-- Available Units -->
  <section class="py-20 bg-bg-primary">
    <div class="container mx-auto px-6">
      <div class="text-center mb-16">
        <h2 class="text-5xl font-bold font-display text-accent mb-6">DostÄ™pne magazyny</h2>
        <p class="text-xl text-gray-300 max-w-2xl mx-auto">
          Wybierz idealnÄ… przestrzeÅ„ dla swoich potrzeb
        </p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {units.map((unit, index) => {
          const isAvailable = availableUnits?.some(u => u.id === parseInt(unit.id.split('-')[1])) ?? false;
          
          return (
            <div
              key={unit.id}
              class={`bg-glass-bg border border-glass-border rounded-3xl p-8 backdrop-blur-xl transition-all duration-300 hover:scale-[1.02] hover:shadow-2xl hover:shadow-accent/20 ${
                !isAvailable ? 'opacity-50' : ''
              }`}
            >
              <div class="aspect-video bg-bg-secondary rounded-2xl mb-6 overflow-hidden">
                {unit.data.image ? (
                  <img 
                    src={unit.data.image} 
                    alt={unit.data.name}
                    class="w-full h-full object-cover"
                  />
                ) : (
                  <div class="w-full h-full flex items-center justify-center">
                    <div class="text-6xl text-gray-600">ðŸ“¦</div>
                  </div>
                )}
              </div>

              <div class="space-y-4">
                <div class="flex items-center justify-between">
                  <h3 class="text-2xl font-bold text-accent font-display">{unit.data.name}</h3>
                  <div class={`px-3 py-1 rounded-full text-sm font-medium ${
                    isAvailable 
                      ? 'bg-green-500/20 text-green-400' 
                      : 'bg-red-500/20 text-red-400'
                  }`}>
                    {isAvailable ? 'DostÄ™pny' : 'ZajÄ™ty'}
                  </div>
                </div>
                
                <div class="text-gray-300">{unit.data.size}</div>
                
                <div class="space-y-2">
                  <div class="text-3xl font-bold text-accent font-display">
                    {unit.data.priceGross / 100} PLN
                    <span class="text-sm font-normal text-gray-400">/miesiÄ…c</span>
                  </div>
                  <div class="text-xs text-gray-500">Brutto (VAT 23%)</div>
                </div>

                <div class="space-y-2 pt-4 border-t border-glass-border">
                  <div class="text-sm text-gray-400 mb-2">PojemnoÅ›Ä‡:</div>
                  <div class="flex items-center space-x-4 text-sm">
                    <span>ðŸ“¦ {unit.data.capacity.cartons} kartonÃ³w</span>
                    {unit.data.capacity.bicycles && (
                      <span>ðŸš² {unit.data.capacity.bicycles} rowery</span>
                    )}
                  </div>
                </div>

                {isAvailable && (
                  <button
                    id={`book-${unit.id}`}
                    class="w-full bg-accent text-text-dark font-bold py-3 rounded-xl hover:bg-gray-300 transition-colors mt-6"
                  >
                    Zarezerwuj teraz
                  </button>
                )}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  </section>

  <!-- Booking Wizard Modal -->
  <div id="bookingWizardContainer"></div>
</LayoutV2>

<script>
  // Otwieranie wizarda
  document.getElementById('openWizard')?.addEventListener('click', () => {
    const container = document.getElementById('bookingWizardContainer');
    if (container) {
      // Tutaj React renderuje BookingWizard
      // W Astro uÅ¼ywamy client:load na komponencie
    }
  });

  // Booking dla kaÅ¼dego magazynu
  document.querySelectorAll('[id^="book-"]').forEach(button => {
    button.addEventListener('click', () => {
      const unitId = button.id.replace('book-', '');
      window.location.href = `/checkout?unit=${unitId}`;
    });
  });
</script>