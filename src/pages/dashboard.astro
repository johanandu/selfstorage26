---
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabase';

// 1. WERYFIKACJA SESJI (SSR)
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const refreshToken = Astro.cookies.get('sb-refresh-token')?.value;

if (!accessToken || !refreshToken) {
  return Astro.redirect('/auth/login?redirect=/dashboard');
}

// Ustawiamy sesjÄ™ dla klienta
const { data: { session }, error } = await supabase.auth.setSession({
  access_token: accessToken,
  refresh_token: refreshToken,
});

if (error || !session) {
  // JeÅ›li token wygasÅ‚ -> wyloguj
  Astro.cookies.delete('sb-access-token', { path: '/' });
  Astro.cookies.delete('sb-refresh-token', { path: '/' });
  return Astro.redirect('/auth/login?redirect=/dashboard');
}

// 2. POBIERANIE DANYCH
// Profil
const { data: profile } = await supabase
  .from('profiles')
  .select('*')
  .eq('id', session.user.id)
  .single();

// Subskrypcje (Magazyny)
const { data: subscriptions } = await supabase
  .from('subscriptions')
  .select(`
    *,
    units (
      id,
      name,
      size,
      gate_code,
      image_url
    )
  `)
  .eq('user_id', session.user.id)
  .eq('status', 'active');

const userName = profile?.full_name || session.user.email;
const hasUnits = subscriptions && subscriptions.length > 0;
---

<Layout title="Panel Klienta">
  <div class="min-h-screen bg-[#09090b] text-white pb-20">
    
    <!-- NAVBAR -->
    <nav class="sticky top-0 z-50 border-b border-white/10 bg-[#09090b]/80 backdrop-blur-md">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="flex h-16 items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-white text-black font-bold">
              S
            </div>
            <span class="font-medium text-gray-200">Panel Klienta</span>
          </div>
          
          <div class="flex items-center gap-4">
            <span class="hidden text-sm text-gray-400 sm:block">{userName}</span>
            <button id="logoutBtn" class="rounded-md border border-white/10 px-3 py-1.5 text-xs font-medium hover:bg-white/10 transition-colors">
              Wyloguj
            </button>
          </div>
        </div>
      </div>
    </nav>

    <main class="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">
      
      <!-- WELCOME HEADER -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold tracking-tight text-white">DzieÅ„ dobry! ðŸ‘‹</h1>
        <p class="mt-2 text-gray-400">ZarzÄ…dzaj swoimi magazynami i dostÄ™pem.</p>
      </div>

      <!-- BENTO GRID LAYOUT -->
      <div class="grid grid-cols-1 gap-4 md:grid-cols-3 md:grid-rows-2 lg:gap-8">
        
        <!-- 1. GÅÃ“WNY KAFEL: TWOJE MAGAZYNY (Zajmuje 2 kolumny) -->
        <div class="group relative overflow-hidden rounded-3xl border border-white/10 bg-[#121214] p-6 md:col-span-2 md:row-span-2">
          <div class="absolute top-0 right-0 p-4 opacity-10">
            <svg class="h-32 w-32" fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v12a2 2 0 002 2h14a2 2 0 002-2V4a2 2 0 00-2-2zm0 14H4V4h16v12z"/></svg>
          </div>

          <div class="relative z-10">
            <h2 class="text-xl font-semibold text-white">Twoje Magazyny</h2>
            
            {hasUnits ? (
              <div class="mt-6 space-y-4">
                {subscriptions.map((sub) => (
                  <div class="flex flex-col sm:flex-row items-center justify-between gap-4 rounded-xl border border-white/5 bg-white/5 p-4 transition-all hover:bg-white/10">
                    <div class="flex items-center gap-4 w-full sm:w-auto">
                      <!-- Obrazek unitu lub placeholder -->
                      <div class="h-14 w-14 flex-shrink-0 rounded-lg bg-gray-800 bg-cover bg-center" 
                           style={`background-image: url('${sub.units.image_url || "https://images.unsplash.com/photo-1590247813693-5541d1c609fd?w=150&h=150&fit=crop"}')`}>
                      </div>
                      <div>
                        <h3 class="font-bold text-white">{sub.units.name}</h3>
                        <p class="text-sm text-gray-400">{sub.units.size} â€¢ Kod: <span class="font-mono text-yellow-500">{sub.units.gate_code || "****"}</span></p>
                      </div>
                    </div>
                    
                    <button 
                      class="gate-btn w-full sm:w-auto rounded-lg bg-white px-6 py-3 font-bold text-black hover:bg-gray-200 transition-all flex items-center justify-center gap-2"
                      data-unit-id={sub.unit_id}
                    >
                      <span>ðŸ”“</span> OTWÃ“RZ BRAMÄ˜
                    </button>
                  </div>
                ))}
              </div>
            ) : (
              /* EMPTY STATE */
              <div class="mt-12 flex flex-col items-center justify-center text-center">
                <div class="rounded-full bg-white/5 p-4 ring-1 ring-white/10">
                  <span class="text-3xl">ðŸ“¦</span>
                </div>
                <h3 class="mt-4 text-lg font-medium text-white">Brak aktywnych magazynÃ³w</h3>
                <p class="mt-2 max-w-sm text-sm text-gray-400">WyglÄ…da na to, Å¼e nie wynajmujesz jeszcze Å¼adnej powierzchni.</p>
                <a 
                  href="/#oferta" 
                  class="mt-6 inline-flex items-center gap-2 rounded-full bg-blue-600 px-6 py-2.5 text-sm font-semibold text-white hover:bg-blue-500 transition-colors"
                >
                  Wynajmij teraz &rarr;
                </a>
              </div>
            )}
          </div>
        </div>

        <!-- 2. STATUS SYSTEMU -->
        <div class="rounded-3xl border border-white/10 bg-[#121214] p-6">
          <div class="flex items-start justify-between">
            <div>
              <p class="text-xs font-medium uppercase tracking-wider text-gray-400">System</p>
              <h3 class="mt-1 text-2xl font-bold text-white">Online</h3>
            </div>
            <span class="relative flex h-3 w-3">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
              <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
            </span>
          </div>
          <div class="mt-8">
            <div class="flex justify-between text-sm">
              <span class="text-gray-400">Brama wjazdowa</span>
              <span class="text-green-400">Aktywna</span>
            </div>
            <div class="mt-2 h-1 w-full rounded-full bg-white/10">
              <div class="h-1 w-full rounded-full bg-green-500"></div>
            </div>
          </div>
        </div>

        <!-- 3. PÅATNOÅšCI / FAKTURY -->
        <div class="rounded-3xl border border-white/10 bg-[#121214] p-6 flex flex-col justify-between">
          <div>
            <p class="text-xs font-medium uppercase tracking-wider text-gray-400">Finanse</p>
            <h3 class="mt-1 text-xl font-bold text-white">Faktury</h3>
          </div>
          
          {hasUnits ? (
            <div class="mt-4">
              <div class="flex items-center justify-between rounded bg-green-500/10 px-3 py-2 text-sm text-green-400 border border-green-500/20">
                <span>Wszystko opÅ‚acone</span>
                <span>âœ“</span>
              </div>
            </div>
          ) : (
             <div class="mt-4 text-sm text-gray-500 italic">Brak historii</div>
          )}
          
          <button class="mt-4 w-full rounded-lg border border-white/10 py-2 text-sm font-medium text-gray-300 hover:bg-white/5 transition-colors">
            Historia transakcji
          </button>
        </div>

      </div>
    </main>
  </div>

  <script>
    import { supabase } from '../lib/supabase';

    // 1. LOGIKA WYLOGOWANIA
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', async () => {
        const { error } = await supabase.auth.signOut();
        // CzyÅ›cimy ciasteczka
        document.cookie = 'sb-access-token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
        document.cookie = 'sb-refresh-token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
        window.location.href = '/auth/login';
      });
    }

    // 2. LOGIKA OTWIERANIA BRAMY (Symulacja + API Call)
    const gateBtns = document.querySelectorAll('.gate-btn');
    gateBtns.forEach(btn => {
      btn.addEventListener('click', async (e) => {
        // Rzutowanie typu
        const button = e.currentTarget as HTMLButtonElement;
        const unitId = button.dataset.unitId;
        const originalContent = button.innerHTML;

        // UI Loading State
        button.disabled = true;
        button.innerHTML = `<svg class="animate-spin h-5 w-5 text-black" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>`;
        button.classList.add('opacity-75');

        try {
          // Tutaj strzaÅ‚ do API
          const response = await fetch('/api/gate/open', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ unitId })
          });

          if (response.ok) {
             button.innerHTML = `<span>ðŸ”“</span> OTWARTE!`;
             button.classList.replace('bg-white', 'bg-green-500');
             
             // Reset po 5 sek
             setTimeout(() => {
                button.innerHTML = originalContent;
                button.disabled = false;
                button.classList.remove('opacity-75');
                button.classList.replace('bg-green-500', 'bg-white');
             }, 5000);
          } else {
             throw new Error('BÅ‚Ä…d poÅ‚Ä…czenia');
          }
        } catch (err) {
          alert('Nie udaÅ‚o siÄ™ otworzyÄ‡ bramy. SprawdÅº poÅ‚Ä…czenie.');
          button.innerHTML = originalContent;
          button.disabled = false;
          button.classList.remove('opacity-75');
        }
      });
    });
  </script>
</Layout>