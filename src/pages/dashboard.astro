---
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabase';

// 1. WERYFIKACJA SESJI
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const refreshToken = Astro.cookies.get('sb-refresh-token')?.value;

if (!accessToken || !refreshToken) {
  return Astro.redirect('/auth/login?redirect=/dashboard');
}

const { data: { session }, error } = await supabase.auth.setSession({
  access_token: accessToken,
  refresh_token: refreshToken,
});

if (error || !session) {
  Astro.cookies.delete('sb-access-token', { path: '/' });
  Astro.cookies.delete('sb-refresh-token', { path: '/' });
  return Astro.redirect('/auth/login?redirect=/dashboard');
}

// 2. DANE
const { data: profile } = await supabase
  .from('profiles')
  .select('*')
  .eq('id', session.user.id)
  .single();

const { data: subscriptions } = await supabase
  .from('subscriptions')
  .select(`*, units (id, name, size, gate_code, image_url)`)
  .eq('user_id', session.user.id)
  .eq('status', 'active');

const userName = profile?.full_name || session.user.email;
const hasUnits = subscriptions && subscriptions.length > 0;
---

<Layout title="Panel Klienta">
  <!-- ZMIANA: UsuniÄ™to sztywne tÅ‚o i padding-top, teraz pasuje do Layoutu -->
  <div class="min-h-screen text-white pb-20 pt-8">
    
    <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      
      <!-- HEADER WEWNÄ˜TRZNY (Zamiast paska nawigacji) -->
      <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8 gap-4 border-b border-white/10 pb-6">
        <div>
          <h1 class="text-3xl font-bold tracking-tight text-white">Witaj, {userName} ðŸ‘‹</h1>
          <p class="mt-1 text-gray-400">Panel zarzÄ…dzania magazynem</p>
        </div>
        <button id="logoutBtn" class="inline-flex items-center justify-center rounded-lg border border-red-500/30 bg-red-500/10 px-4 py-2 text-sm font-medium text-red-400 hover:bg-red-500/20 transition-colors w-full md:w-auto">
          Wyloguj siÄ™
        </button>
      </div>

      <!-- BENTO GRID -->
      <div class="grid grid-cols-1 gap-4 md:grid-cols-3 md:grid-rows-2 lg:gap-8">
        
        <!-- TWOJE MAGAZYNY -->
        <div class="group relative overflow-hidden rounded-3xl border border-white/10 bg-[#121214] p-6 md:col-span-2 md:row-span-2">
          <div class="relative z-10">
            <h2 class="text-xl font-semibold text-white mb-6">Twoje Magazyny</h2>
            
            {hasUnits ? (
              <div class="space-y-4">
                {subscriptions.map((sub) => (
                  <div class="flex flex-col sm:flex-row items-center justify-between gap-4 rounded-xl border border-white/5 bg-white/5 p-4 hover:bg-white/10 transition-all">
                    <div class="flex items-center gap-4 w-full">
                      <div class="h-12 w-12 rounded-lg bg-gray-800 bg-cover bg-center" 
                           style={`background-image: url('${sub.units.image_url || "https://images.unsplash.com/photo-1590247813693-5541d1c609fd?w=150&h=150&fit=crop"}')`}>
                      </div>
                      <div>
                        <h3 class="font-bold text-white">{sub.units.name}</h3>
                        <p class="text-sm text-gray-400">{sub.units.size} â€¢ Kod: <span class="text-yellow-500 tracking-widest">{sub.units.gate_code || "****"}</span></p>
                      </div>
                    </div>
                    <button 
                      class="gate-btn w-full sm:w-auto whitespace-nowrap rounded-lg bg-white px-6 py-3 font-bold text-black hover:bg-gray-200 transition-all shadow-lg shadow-white/10"
                      data-unit-id={sub.unit_id}
                    >
                      OTWÃ“RZ BRAMÄ˜
                    </button>
                  </div>
                ))}
              </div>
            ) : (
              <div class="flex flex-col items-center justify-center py-10 text-center">
                <div class="text-4xl mb-4 opacity-50">ðŸ“¦</div>
                <h3 class="text-lg font-medium text-white">Brak aktywnych magazynÃ³w</h3>
                <a href="/#oferta" class="mt-4 text-blue-400 hover:text-blue-300 underline">PrzejdÅº do oferty</a>
              </div>
            )}
          </div>
        </div>

        <!-- STATUS -->
        <div class="rounded-3xl border border-white/10 bg-[#121214] p-6">
          <div class="flex items-start justify-between">
            <div>
              <p class="text-xs font-medium uppercase tracking-wider text-gray-400">Status Obiektu</p>
              <h3 class="mt-1 text-2xl font-bold text-white">Online</h3>
            </div>
            <span class="relative flex h-3 w-3">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
              <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
            </span>
          </div>
        </div>

        <!-- PÅATNOÅšCI -->
        <div class="rounded-3xl border border-white/10 bg-[#121214] p-6">
          <p class="text-xs font-medium uppercase tracking-wider text-gray-400">PÅ‚atnoÅ›ci</p>
          <div class="mt-4 flex items-center gap-2 text-green-400 bg-green-500/10 px-3 py-2 rounded-lg border border-green-500/20 w-fit">
            <span>âœ“</span> <span class="text-sm font-medium">OpÅ‚acone</span>
          </div>
        </div>

      </div>
    </main>
  </div>

  <script>
    import { supabase } from '../lib/supabase';

    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', async () => {
        await supabase.auth.signOut();
        document.cookie = 'sb-access-token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
        document.cookie = 'sb-refresh-token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
        window.location.href = '/auth/login';
      });
    }

    // ObsÅ‚uga bramy (Symulacja)
    document.querySelectorAll('.gate-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const button = e.currentTarget as HTMLButtonElement;
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = 'Otwieranie...';
        
        setTimeout(() => {
          button.innerHTML = 'OTWARTE!';
          button.classList.add('bg-green-500', 'text-white');
          button.classList.remove('bg-white', 'text-black');
          
          setTimeout(() => {
            button.innerHTML = originalText;
            button.disabled = false;
            button.classList.remove('bg-green-500', 'text-white');
            button.classList.add('bg-white', 'text-black');
          }, 3000);
        }, 1500);
      });
    });
  </script>
</Layout>