---
import Layout from '../layouts/Layout.astro';
import GateButton from '../components/ui/GateButton.jsx';
import { supabase } from '../lib/supabase';

// Sprawd≈∫ autoryzacjƒô
const token = Astro.cookies.get('sb-access-token');

if (!token) {
  return Astro.redirect('/auth/login?redirect=/dashboard');
}

// Pobierz u≈ºytkownika
const { data: { user }, error: authError } = await supabase.auth.getUser(token.value);

if (authError || !user) {
  Astro.cookies.delete('sb-access-token', { path: '/' });
  return Astro.redirect('/auth/login?redirect=/dashboard');
}

// Pobierz dane u≈ºytkownika z bazy
const { data: profile, error: profileError } = await supabase
  .from('profiles')
  .select('*')
  .eq('id', user.id)
  .single();

// Pobierz aktywne subskrypcje u≈ºytkownika
const { data: subscriptions, error: subError } = await supabase
  .from('subscriptions')
  .select(`
    *,
    units (
      id,
      name,
      size,
      price_gross,
      image_url
    )
  `)
  .eq('user_id', user.id)
  .eq('status', 'active')
  .gte('valid_until', new Date().toISOString());

// Pobierz historiƒô transakcji
const { data: transactions, error: transError } = await supabase
  .from('subscriptions')
  .select(`
    *,
    units (
      name,
      size
    )
  `)
  .eq('user_id', user.id)
  .order('created_at', { ascending: false })
  .limit(10);

const formatPrice = (price: number) => {
  return (price / 100).toFixed(2);
};

const formatDate = (date: string) => {
  return new Date(date).toLocaleDateString('pl-PL');
};
---

<Layout title="Panel Klienta - Self-Storage">
  <div class="min-h-screen bg-background pt-24">
    <div class="container mx-auto px-6">
      <!-- Welcome Section -->
      <div class="bg-primary rounded-3xl p-8 mb-12 border border-secondary">
        <div class="flex items-center justify-between flex-wrap gap-6">
          <div>
            <h1 class="text-4xl font-bold text-accent font-canela mb-2">
              Witaj, {profile?.full_name || user.email}!
            </h1>
            <p class="text-gray-300 text-lg">
              {subscriptions && subscriptions.length > 0 
                ? `Masz ${subscriptions.length} aktywnych magazyn√≥w` 
                : 'Nie masz jeszcze wynajƒôtych magazyn√≥w'}
            </p>
          </div>
          
          <div class="text-right">
            <div class="text-sm text-gray-400 mb-1">Tw√≥j NIP</div>
            <div class="text-accent font-semibold">
              {profile?.nip || 'Nie podano'}
            </div>
          </div>
        </div>
      </div>

      <!-- Active Subscriptions -->
      {subscriptions && subscriptions.length > 0 ? (
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
          {subscriptions.map((sub) => (
            <div class="bg-primary rounded-2xl p-6 border border-secondary">
              <div class="flex items-start justify-between mb-6">
                <div>
                  <h3 class="text-2xl font-bold text-accent font-canela mb-2">
                    {sub.units.name}
                  </h3>
                  <p class="text-gray-300">{sub.units.size}</p>
                </div>
                
                {sub.units.image_url && (
                  <img 
                    src={sub.units.image_url} 
                    alt={sub.units.name}
                    class="w-20 h-20 rounded-lg object-cover"
                  />
                )}
              </div>

              <div class="space-y-4">
                <div class="flex justify-between items-center">
                  <span class="text-gray-300">Cena miesiƒôczna:</span>
                  <span class="text-2xl font-bold text-accent">
                    {formatPrice(sub.units.price_gross)} PLN
                  </span>
                </div>
                
                <div class="flex justify-between items-center">
                  <span class="text-gray-300">Wa≈ºny do:</span>
                  <span class="font-semibold text-green-400">
                    {formatDate(sub.valid_until)}
                  </span>
                </div>

                <div class="border-t border-secondary pt-4">
                  <GateButton
                    unitId={sub.unit_id}
                    client:load
                    isSubscribed={true}
                    onOpenGate={async () => {
                      const response = await fetch('/api/gate/open', {
                        method: 'POST',
                        headers: {
                          'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ unitId: sub.unit_id }),
                      });
                      
                      const result = await response.json();
                      
                      if (response.ok) {
                        alert('Brama otwarta pomy≈õlnie!');
                      } else {
                        alert(`B≈ÇƒÖd: ${result.error}`);
                      }
                    }}
                  />
                </div>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="bg-primary rounded-2xl p-12 text-center border border-secondary mb-12">
          <div class="text-6xl mb-6">üè†</div>
          <h3 class="text-2xl font-bold text-accent mb-4">Nie masz jeszcze magazynu</h3>
          <p class="text-gray-300 mb-8 max-w-md mx-auto">
            PrzeglƒÖdaj dostƒôpne jednostki i wybierz odpowiedniƒÖ dla siebie.
          </p>
          <a 
            href="/"
            class="inline-block bg-accent text-text-dark font-bold py-3 px-8 rounded-full hover:bg-gray-300 transition-colors"
          >
            Zobacz ofertƒô
          </a>
        </div>
      )}

      <!-- Transaction History -->
      {transactions && transactions.length > 0 && (
        <div class="bg-primary rounded-2xl p-8 border border-secondary">
          <h2 class="text-2xl font-bold text-accent font-canela mb-6">Historia transakcji</h2>
          
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="border-b border-secondary">
                  <th class="text-left py-3 text-gray-300">Magazyn</th>
                  <th class="text-left py-3 text-gray-300">Status</th>
                  <th class="text-left py-3 text-gray-300">Data rozpoczƒôcia</th>
                  <th class="text-left py-3 text-gray-300">Data zako≈Ñczenia</th>
                </tr>
              </thead>
              <tbody>
                {transactions.map((trans) => (
                  <tr class="border-b border-secondary/50">
                    <td class="py-4">
                      <div>
                        <div class="font-semibold text-accent">{trans.units?.name}</div>
                        <div class="text-sm text-gray-400">{trans.units?.size}</div>
                      </div>
                    </td>
                    <td class="py-4">
                      <span class={`inline-block px-3 py-1 rounded-full text-sm font-medium ${
                        trans.status === 'active' 
                          ? 'bg-green-500/20 text-green-400' 
                          : 'bg-red-500/20 text-red-400'
                      }`}>
                        {trans.status === 'active' ? 'Aktywny' : 'Nieaktywny'}
                      </span>
                    </td>
                    <td class="py-4 text-gray-300">{formatDate(trans.created_at)}</td>
                    <td class="py-4 text-gray-300">{formatDate(trans.valid_until)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}
    </div>
  </div>
</Layout>